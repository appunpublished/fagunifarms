<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Xylophone </title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#facc15',
                        'dark-bg': '#1f2937',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Tone.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Web App Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJpY29ucyI6W3sic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyIsInNyYyI6Imh0dHBzOi8vcGxhY2Vob2xkLmNvLzE5MngxOTIvaDMwMzM0Zi9mZmYifSx7InNpemVzOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyIsInNyYyI6Imh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1MTIvaDMwMzM0Zi9mZmYifV0sIm5hbWUiOiJHbG9ja2Vuc3BpZWwgWHlsb3Bob25lIiwiZGlzcGxheSI6ImZ1bGxzY3JlZW4iLCJzdGFydF91cmwiOiIuLyIsInNjb3BlIjoiLi8iLCJkZXNjcmlwdGlvbiI6IlBsYXkgYSByZWFsaXN0aWMgc291bmRpbmcgeHlsb3Bob25lIG9ubGluZSBhbmQgb2ZmbGluZS4iLCJ0aGVtZV9jb2xvciI6IiMxZjI5MzciLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzFnMjkzNyJ9">

    <style>
        /* Custom styles for the metallic keys */
        .key-bar {
            transition: all 0.05s ease-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transform: translateY(0);
        }
        .key-bar:active {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
            transform: translateY(2px);
            opacity: 0.8;
        }

        /* Responsive layout for bars */
        .key-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr); /* 8 keys */
            gap: 0.75rem; /* Space between keys */
            padding: 1rem;
        }

        /* Adjust width on smaller screens */
        @media (max-width: 640px) {
            .key-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 0.5rem;
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 font-sans">

    <!-- Main Container -->
    <div id="app" class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 md:p-8">
        <h1 class="text-4xl font-bold text-center text-primary mb-2 tracking-tight">
            My Xylophone
        </h1>
        <p class="text-center text-gray-500 mb-6">Click or tap the bars to play!</p>

        <!-- The Xylophone Grid -->
        <div id="keyboard" class="key-grid">
            <!-- Keys will be dynamically generated here -->
        </div>
        
        <!-- Controls & Status -->
        <div class="mt-8 flex flex-col items-center">
            <button id="start-audio" class="px-6 py-3 bg-secondary text-dark-bg font-bold rounded-lg shadow-md hover:bg-yellow-400 transition transform hover:scale-105">
                Start Audio
            </button>
            <p id="audio-status" class="mt-4 text-sm text-gray-600">Please click "Start Audio" to enable sound.</p>
        </div>
    </div>

    <script>
        // --- PWA Service Worker Registration ---
        const CACHE_NAME = 'xylophone-v3'; // Increased version for new sound engine
        const urlsToCache = ['index.html'];

        if ('serviceWorker' in navigator) {
            // Register service worker
            navigator.serviceWorker.register('./index.html', { scope: './' })
                .then(registration => {
                    console.info('Service Worker registered successfully with scope:', registration.scope);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
            
            // Listen for fetch events to serve from cache
            self.addEventListener('fetch', (event) => {
                event.respondWith(
                    caches.match(event.request)
                        .then(response => {
                            // Cache hit - return response
                            if (response) {
                                return response;
                            }
                            // No cache match - fetch from network
                            return fetch(event.request);
                        })
                );
            });

            // Listen for install event to pre-cache assets
            self.addEventListener('install', (event) => {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then((cache) => {
                            console.info('Opened cache');
                            return cache.addAll(urlsToCache);
                        })
                );
            });

            // Listen for activate event to clear old caches
            self.addEventListener('activate', (event) => {
                const cacheWhitelist = [CACHE_NAME];
                event.waitUntil(
                    caches.keys().then(cacheNames => {
                        return Promise.all(
                            cacheNames.map(cacheName => {
                                if (cacheWhitelist.indexOf(cacheName) === -1) {
                                    return caches.delete(cacheName);
                                }
                            })
                        );
                    })
                );
            });
        }


        // --- Audio Logic (Tone.js) ---

        let xylophone = null;
        let isAudioReady = false;

        // Custom FM Synth configuration for a bright, percussive, metallic tone (Glockenspiel/Xylophone)
        const glockenspielConfig = {
            volume: -8,
            oscillator: { type: 'sine' },
            envelope: {
                attack: 0.005,
                decay: 0.8,
                sustain: 0.0,
                release: 0.8,
            },
            modulation: { type: 'triangle' },
            modulationEnvelope: {
                attack: 0.001,
                decay: 0.3,
                sustain: 0.0,
                release: 0.3
            },
            harmonicity: 3.0, // Higher harmonicity adds that metallic bell-like quality
            // Modulation index is handled by the modulation envelope's depth
        };

        const notes = [
            { note: 'C4', color: '#ef4444', size: 1.0 }, // Red
            { note: 'D4', color: '#f97316', size: 0.95 }, // Orange
            { note: 'E4', color: '#fbbf24', size: 0.9 }, // Yellow
            { note: 'F4', color: '#22c55e', size: 0.85 }, // Green
            { note: 'G4', color: '#06b6d4', size: 0.8 }, // Cyan
            { note: 'A4', color: '#3b82f6', size: 0.75 }, // Blue
            { note: 'B4', color: 'indigo-500', size: 0.7 }, // Indigo
            { note: 'C5', color: '#ec4899', size: 0.65 }  // Pink
        ];

        // Function to set up the audio context and instrument
        function setupAudio() {
            if (xylophone) return; // Already set up

            // Use a PolySynth with the custom FMSynth voice
            xylophone = new Tone.PolySynth(
                Tone.FMSynth, 
                glockenspielConfig
            ).toDestination();
            
            isAudioReady = true;
            document.getElementById('audio-status').textContent = 'Audio is ready!';
            document.getElementById('start-audio').classList.add('hidden');
            console.log("Audio Context and Xylophone Instrument Initialized.");
        }

        // Play the specified note
        function playNote(note) {
            if (isAudioReady) {
                // Trigger the attack (start) immediately, and release (stop) after a short duration
                xylophone.triggerAttackRelease(note, "8n");
            } else {
                console.warn("Audio not started. Please click 'Start Audio'.");
            }
        }

        // --- DOM/UI Logic ---
        
        const keyboard = document.getElementById('keyboard');

        // Dynamically create the xylophone keys
        function createKeys() {
            notes.forEach((key, index) => {
                const bar = document.createElement('div');
                
                // Determine width based on the size property
                const widthFactor = 2.5 + (key.size * 5.5); // 8 is max width in Tailwind grid (1fr * 8), adjust to fit visually
                const tailwindWidth = `w-[${widthFactor}rem]`;

                // Calculate key color (using Tailwind classes where possible, direct hex otherwise)
                const bgColorClass = key.color.startsWith('#') ? `bg-[${key.color}]` : `bg-${key.color}`;
                
                bar.className = `key-bar rounded-full ${bgColorClass} hover:opacity-90 cursor-pointer flex items-center justify-center font-bold text-white shadow-xl`;
                bar.style.height = '2rem';
                bar.style.width = `${key.size * 100}%`; // Use size to scale width (for visual effect)
                bar.style.minWidth = '30px'; // Minimum width for mobile tapping
                bar.style.margin = '0 auto'; // Center in the grid cell

                // The visual length of the bar represents the note pitch
                bar.style.height = `${80 + (index * 20)}px`;
                bar.style.backgroundColor = key.color; 
                bar.dataset.note = key.note;

                // Create a div wrapper for the bar to sit in the grid cell
                const wrapper = document.createElement('div');
                wrapper.className = 'flex flex-col items-center justify-end h-full'; 
                wrapper.style.minHeight = '180px';
                wrapper.appendChild(bar);

                wrapper.addEventListener('pointerdown', (e) => {
                    e.preventDefault();
                    if (!isAudioReady) {
                        Tone.start();
                        setupAudio();
                    }
                    if (isAudioReady) {
                        playNote(key.note);
                    }
                });

                keyboard.appendChild(wrapper);
            });
        }

        // Start button handler
        document.getElementById('start-audio').addEventListener('click', async () => {
            if (Tone.context.state !== 'running') {
                await Tone.start();
            }
            setupAudio();
        });


        // Initialize UI on load
        window.onload = createKeys;
        
    </script>
</body>
</html>
